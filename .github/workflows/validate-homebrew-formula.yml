---
name: Quality Check - Homebrew Formula Validation (Tap)

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'Formula/**'
      - '.github/workflows/validate-homebrew-formula.yml'
  push:
    branches: [ main ]
    paths:
      - 'Formula/**'

permissions:
  contents: read

jobs:
  validate-formula:
    runs-on: macos-14
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0

      - name: Show environment
        run: |
          sw_vers
          brew --version
          ruby --version

      - name: Brew style (all formulas)
        run: |
          for formula in Formula/*.rb; do
            echo "Checking style for $formula"
            brew style "$formula"
          done

      - name: Brew audit (all formulas)
        run: |
          for formula in Formula/*.rb; do
            echo "Auditing $formula"
            brew audit --strict --online "$formula"
          done

      - name: Install from source (smoke test)
        run: |
          for formula in Formula/*.rb; do
            formula_name=$(basename "$formula" .rb)
            echo "Installing $formula_name from $formula"
            brew install --build-from-source "$formula"
            # Test that the binary exists and runs
            if command -v "$formula_name" >/dev/null 2>&1; then
              "$formula_name" --version || "$formula_name" version || true
            fi
          done


