---
name: Scheduled Formula Validation

"on":
  schedule:
    # Run every Sunday at 6:00 AM UTC
    - cron: '0 6 * * 0'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

env:
  FORMULA_NAME: lintro
  PYPI_PACKAGE: lintro

jobs:
  validate-formula:
    name: Validate Formula Installation
    runs-on: macos-14
    timeout-minutes: 20
    outputs:
      formula_version: ${{ steps.version-check.outputs.formula_version }}
      pypi_version: ${{ steps.version-check.outputs.pypi_version }}
      has_drift: ${{ steps.version-check.outputs.has_drift }}
    steps:
      - name: Checkout
        # v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0

      - name: Check version drift
        id: version-check
        run: |
          scripts/ci/check-version-drift.sh \
            "${{ env.FORMULA_NAME }}" \
            "${{ env.PYPI_PACKAGE }}"

      - name: Validate formula
        run: scripts/ci/validate-formulas.sh

  report-version-drift:
    name: Report Version Drift
    needs: validate-formula
    if: needs.validate-formula.outputs.has_drift == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        # v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Report version drift
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          source scripts/lib/github-issues.sh
          report_version_drift \
            "${{ needs.validate-formula.outputs.formula_version }}" \
            "${{ needs.validate-formula.outputs.pypi_version }}"

  notify-failure:
    name: Notify on Failure
    needs: validate-formula
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        # v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Report validation failure
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          source scripts/lib/github-issues.sh
          RUN_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}"
          RUN_URL="${RUN_URL}/actions/runs/${GITHUB_RUN_ID}"
          report_validation_failure "$RUN_URL"
