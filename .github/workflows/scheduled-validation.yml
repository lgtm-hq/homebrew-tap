---
name: Scheduled Formula Validation

on:
  schedule:
    # Run every Sunday at 6:00 AM UTC
    - cron: '0 6 * * 0'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

env:
  FORMULA_NAME: lintro
  PYPI_PACKAGE: lintro

jobs:
  validate-formula:
    name: Validate Formula Installation
    runs-on: macos-14
    timeout-minutes: 20
    outputs:
      formula_version: ${{ steps.version-check.outputs.formula_version }}
      pypi_version: ${{ steps.version-check.outputs.pypi_version }}
      has_drift: ${{ steps.version-check.outputs.has_drift }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Check version drift
        id: version-check
        run: scripts/ci/check-version-drift.sh "${{ env.FORMULA_NAME }}" "${{ env.PYPI_PACKAGE }}"

      - name: Validate formula
        run: scripts/ci/validate-formulas.sh

  report-version-drift:
    name: Report Version Drift
    needs: validate-formula
    if: needs.validate-formula.outputs.has_drift == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Create issue for version drift
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const formulaVersion = '${{ needs.validate-formula.outputs.formula_version }}';
            const pypiVersion = '${{ needs.validate-formula.outputs.pypi_version }}';

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'version-drift'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('Version drift detected')
            );

            if (existingIssue) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## Updated Version Check\n\n- Formula: \`${formulaVersion}\`\n- PyPI: \`${pypiVersion}\`\n\nChecked: ${new Date().toISOString()}`
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Version drift detected: formula ${formulaVersion} vs PyPI ${pypiVersion}`,
                body: `## Version Drift Detected\n\n| Source | Version |\n|--------|--------|\n| Formula | \`${formulaVersion}\` |\n| PyPI | \`${pypiVersion}\` |\n\nThe formula should be automatically updated when a new release is published. Check the py-lintro release workflow if this persists.\n\n---\n*Auto-created by scheduled validation.*`,
                labels: ['version-drift', 'automated']
              });
            }

  notify-failure:
    name: Notify on Failure
    needs: validate-formula
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Create issue for validation failure
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'validation-failure'
            });

            if (!issues.data.find(i => i.title.includes('Formula validation failed'))) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Formula validation failed in scheduled check',
                body: `## Scheduled Validation Failed\n\n[View logs](${runUrl})\n\nPossible causes:\n- Upstream dependency changes\n- Homebrew API changes\n- macOS runner changes\n\n---\n*Auto-created by scheduled validation.*`,
                labels: ['validation-failure', 'automated', 'bug']
              });
            }
